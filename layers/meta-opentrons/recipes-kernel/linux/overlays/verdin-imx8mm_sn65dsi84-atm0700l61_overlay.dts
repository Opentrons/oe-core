// SPDX-License-Identifier: Apache-2
/*
 * Copyright 2020-2021 Opentrons
 */

// Verdin DSI to LVDS Adapter with connected ATM0700L61-CT display (7 inch) with a
// resolution of 1024x600 pixel. Semicustom from AZ Displays.

/dts-v1/;
/plugin/;

/ {
    compatible = "toradex,verdin-imx8mm";
};

#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/pwm/pwm.h>
#include <dt-bindings/interrupt-controller/irq.h>
#include "verdin-imx8mm_backlight-dsi_overlay.dtsi"
#include "display-lt170410-dsi-lvds_overlay.dtsi"

&{/} {
	reg_dsi_lvds: regulator-dsi-lvds {
		compatible = "regulator-fixed";
		enable-active-high;
		/* Verdin CTRL_SLEEP_MOCI# (SODIMM 256) */
		gpio = <&gpio4 29 GPIO_ACTIVE_HIGH>;
		regulator-boot-on;
		regulator-name = "DSI_1_PWR_EN";
	};
};

&backlight_verdin_dsi {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_i2s_2_d_out_dsi_1_bkl_en>;
	/* Verdin I2S_2_D_OUT (DSI_1_BKL_EN/DSI_1_BKL_EN_LVDS, SODIMM 46) */
	enable-gpios = <&gpio5 1 GPIO_ACTIVE_HIGH>;
	pwms = <&pwm3 0 6666667 PWM_POLARITY_INVERTED>;
};

&gpu_2d {
	status = "okay";
};

&gpu_3d {
	status = "okay";
};

/* Verdin I2C_1 */
&i2c4 {
	#address-cells = <1>;
	#size-cells = <0>;
	status = "okay";

	bridge@2c {
		compatible = "ti,sn65dsi84";
		reg = <0x2c>;
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_gpio_10_dsi>;
		/* Verdin GPIO_9_DSI (SN65DSI84 IRQ, SODIMM 17, unused) */
		/* Verdin GPIO_10_DSI (SODIMM 21) */
		enable-gpios = <&gpio4 28 GPIO_ACTIVE_HIGH>;
		vcc-supply = <&reg_dsi_lvds>;
		status = "okay";

		ports {
			#address-cells = <1>;
			#size-cells = <0>;

			port@0 {
				reg = <0>;

				dsi_lvds_bridge_in: endpoint {
					data-lanes = <1 2 3 4>;
					remote-endpoint = <&mipi_dsi_bridge1_out>;
				};
			};

			port@2 {
				reg = <2>;

				dsi_lvds_bridge_out: endpoint {
					remote-endpoint = <&panel_in_lt170410>;
				};
			};
		};
	};

	touch@4a {
		compatible = "atmel,maxtouch";
		reg = <0x4a>;
		/*
		 * Verdin GPIO_9_DSI
		 * (TOUCH_INT#, SODIMM 17, also routed to SN65DSI84 IRQ albeit currently unused)
		 */
		interrupt-parent = <&gpio4>;
		interrupts = <25 IRQ_TYPE_EDGE_FALLING>;
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_gpio_9_dsi>, <&pinctrl_i2s_2_bclk_touch_reset>;
		/* Verdin I2S_2_BCLK (TOUCH_RESET#, SODIMM 42) */
		reset-gpios = <&gpio5 0 GPIO_ACTIVE_LOW>;
		vdd-supply = <&reg_dsi_lvds>;
		status = "okay";
	};
};

/* LCDIF to MIPI-DSI */
&lcdif1 {
	status = "okay";
};

&mipi_dsi {
	#address-cells = <1>;
	#size-cells = <0>;
	status = "okay";

	port@1 {
		mipi_dsi_bridge1_out: endpoint {
			attach-bridge;
			remote-endpoint = <&dsi_lvds_bridge_in>;
		};
	};
};

&mix_gpu_ml {
	status = "okay";
};

&ml_vipsi {
	status = "okay";
};


&vpu_g1 {
	status = "okay";
};

&vpu_g2 {
	status = "okay";
};

&vpu_vc8000e {
	status = "okay";
};

&vpu_v4l2 {
	status = "okay";
};


&{/} {
	panel_lvds: panel-lvds {
		compatible = "panel-lvds";
		data-mapping = "vesa-24";
		height-mm = <86>;
		width-mm = <154>;
		status = "okay";
		backlight = <&backlight_verdin_dsi>;

		port {
			panel_in_lt170410: endpoint {
				remote-endpoint = <&dsi_lvds_bridge_out>;
			};
		};

		panel-timing {
			clock-frequency = <51200000>;
			hactive = <1024 1024 1024>;
			hfront-porch = <16 160 216>;
			hback-porch = <160 160 160>;
			hsync-len = <1 70 140>;
			vactive = <600 600 600>;
			vfront-porch = <1 12 127>;
			vback-porch = <23 23 23>;
			vsync-len = <1 10 20>;
			de-active = <1>;
			pixelclk-active = <0>;
		};
	};
};


/* Verdin I2C_2_DSI */
&i2c2 {
	status = "okay";
};

/* Verdin PWM_3_DSI */
&pwm1 {
	status = "okay";
};

